---
page_type: sample
description: "Применение MVC ASP.NET Core 2.1 для подключения к Microsoft Graph с использованием потока делегированных разрешений."
products:
- ms-graph
languages:
- aspx
- csharp
extensions:
  contentType: samples
  technologies:
  - Microsoft Graph
  - Microsoft identity platform
  services:
  - Microsoft identity platform
  createdDate: 8/6/2017 5:17:58 AM
---
# Пример приложения, подключающегося к Microsoft Graph, для ASP.NET Core 2.1

![Снимок экрана с примером приложения, подключающегося к Microsoft Graph, для ASP.NET Core 2.1](readme-images/Page1.PNG)

**Сценарий** С помощью MVC ASP.NET Core 2.1 подключитесь к Microsoft Graph, используя поток делегированных разрешений, и получите данные профиля пользователя и его фотографию из конечной точки Azure AD (v2.0), а затем отправьте сообщение электронной почты, вложив в него эту фотографию.

В этом примере используется OpenID Connect для входа, [библиотека проверки подлинности Майкрософт (MSAL) для .NET](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet) для получения маркера доступа и [клиентская библиотека Microsoft Graph для .NET](https://github.com/microsoftgraph/msgraph-sdk-dotnet) (SDK) для взаимодействия с Microsoft Graph. В пакете SDK MSAL предусмотрены функции для работы с [конечной точкой Azure AD версии 2.0](https://azure.microsoft.com/en-us/documentation/articles/active-directory-appmodel-v2-overview), что позволяет разработчикам создать единый поток кода для проверки подлинности как рабочих или учебных (Azure Active Directory), так и личных учетных записей Майкрософт.
В примере используются только делегированные разрешения, поэтому он не требует согласия администратора.

> Чтобы ознакомиться с предыдущей версией этого примера, в которой используется ASP.NET Core версии 1.1, нажмите [здесь](https://github.com/microsoftgraph/aspnetcore-connect-sample/tree/netcore1.1), а с версией, использующей ASP.NET Core 2.0 — [здесь](https://github.com/microsoftgraph/aspnetcore-connect-sample/tree/netcore2.0).

## Содержание

- [Предварительные требования](#prerequisites)
- [Регистрация приложения](#register-the-app)
- [Настройка и запуск примера](#configure-and-run-the-sample)
- [Ключевые компоненты примера](#key-components-of-the-sample)
- [Участие](#contributing)
- [Вопросы и комментарии](#questions-and-comments)
- [Дополнительные ресурсы](#additional-resources)

## Различия между ADAL и MSAL

ADAL (Azure AD v 1.0) и MSAL (Azure AD v 2.0) — это библиотеки проверки подлинности для различных языков, позволяющие получать маркеры из Azure AD для доступа к защищенным веб-API (API Майкрософт или приложениям, зарегистрированным в Azure Active Directory). Приложения ADAL позволяют пользователям входить в систему с помощью своей рабочей или учебной учетной записи и должны регистрироваться на [портале Azure](https://portal.azure.com/), а приложения, использующие новую (в ознакомительной версии) MSAL, позволяют входить как с помощью рабочей или учебной, так и с помощью личной учетной записи и должны регистрироваться на [портале регистрации приложений](https://apps.dev.microsoft.com/), если они не являются приложениями Azure AD B2C. Как в ADAL, так и в MSAL есть клиентские библиотеки .NET: [ADAL.NET](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet) и [MSAL.NET](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet) соответственно. [Подробнее о миграции и различиях между ADAL.NET и MSAL.NET здесь.](https://github.com/AzureAD/microsoft-authentication-library-for-dotnet/wiki/adal-to-msal)

## Предварительные требования

Чтобы использовать пример приложения для ASP.NET Core 2.1, подключающегося с использованием Microsoft Graph, потребуется следующее:

- Набор инструментов Visual Studio 2017 [с SDK .NET Core 2.1 ](https://www.microsoft.com/net/download/core), установленный на компьютере для разработки.
- [Личная учетная запись Майкрософт](https://signup.live.com) либо [рабочая или учебная учетная запись](https://dev.office.com/devprogram). (Вам не требуется быть администратором клиента.)
- Идентификатор и ключ приложения, которое вы [регистрируете на портале регистрации приложений](#register-the-app).

## Регистрация приложения

1. Перейдите на [портал Azure AD](https://portal.azure.com). Войдите с помощью **личной учетной записи** (т. е. учетной записи Майкрософт) или **рабочей или учебной учетной записи** с разрешениями на регистрацию приложений.

   > **Примечание.** Если у вас нет разрешений на регистрацию приложений, обратитесь к администратору вашего домена Azure AD.

2. В меню навигации слева выберите **Azure Active Directory**.

3. В области навигации текущей колонки выберите пункт **Регистрация приложений**.

4. В области навигации текущей колонки выберите пункт **Новая регистрация**.

5. На странице **Регистрация приложения** задайте следующие значения параметров:

   - **Название** = [Введите название приложения]
   - **Поддерживаемые типы учетных записей** = [Выберите нужное значение]
   - **URI перенаправления**
     - Тип (раскрывающийся список) = Web
     - Значение = `https://localhost:44334/signin-oidc`

   > **Примечание.** Убедитесь в том, что значение URI перенаправления уникально в вашем домене. Его можно изменить позже, и оно может не указывать URI размещенного ресурса. Если приведенный выше пример URI уже используется, выберите уникальное значение.

   1. В разделе **Дополнительные параметры** задайте следующее значение**URL-адреса выхода**: `https://localhost:44334/Account/SignOut`.
   2. Скопируйте **URI перенаправления**, поскольку он потребуется вам позже.

6. После того, как приложение будет создано, скопируйте **идентификатор приложения (клиента)** и **идентификатор каталога (клиента)** с обзорной страницы и временно сохраните их, поскольку оба этих идентификатора потребуются вам позже.

7. Выберите **Сертификаты и секреты** в области навигации текущей колонки.

   1. Выберите **Создать секрет клиента**.
   2. В диалоговом окне **Добавление секрета клиента** введите следующие значения:

      - **Описание** = MyAppSecret1
      - **Срок действия** = 1 год

   3. Нажмите кнопку **Добавить**.

   4. После того как на экране появится только что созданный секрет клиента, скопируйте **ЗНАЧЕНИЕ** секрета и временно сохраните его, так как оно потребуется вам позже.

      > **Важно!**
      > Эта секретная строка никогда не отображается снова, поэтому убедитесь, что вы ее скопировали. В производственных приложениях всегда следует использовать сертификаты в качестве секретов приложений, но в этом примере мы будем использовать простой общий секретный пароль.

8. В области навигации текущей колонки выберите пункт **Проверка подлинности**.
   1. Выберите "Маркеры идентификаторов".
9. В области навигации текущей колонки выберите пункт **Разрешения API**.

   1. В области навигации текущей колонки выберите пункт **Добавить разрешение**.
   2. На панели **Запрос разрешения API** выберите **Microsoft Graph**.

   3. Выберите **Делегированные разрешения**.
   4. В поисковом поле "Выбор разрешений" введите "Пользователь".
   5. Выберите **openid**, **email**, **profile**, **offline_access**, **User.Read**, **User.ReadBasic.All** и **Mail.Send**.

   6. Нажмите кнопку **Добавить разрешения** в нижней части всплывающего меню.

   > **Примечание.** Майкрософт рекомендует явно перечислить все делегированные разрешения при регистрации приложения. Хотя благодаря возможностям добавочного и динамического согласия конечной точки версии 2 этот шаг не является обязательным, его пропуск может негативно сказаться на согласии администратора.

## Настройка и запуск примера

1. Скачайте или клонируйте пример приложения, подключающегося к Microsoft Graph, для ASP.NET Core.

2. Откройте пример файла **MicrosoftGraphAspNetCoreConnectSample.sln** в Visual Studio 2017.

3. В обозревателе решений откройте файл **appsettings.json** в корневом каталоге проекта.

   а. Для ключа **AppId** замените `ENTER_YOUR_APP_ID` идентификатором зарегистрированного вами приложения.

   б. Для ключа **AppSecret** замените `ENTER_YOUR_SECRET` паролем зарегистрированного вами приложения. Обратите внимание на то, что в производственных приложениях всегда следует использовать сертификаты в качестве секретов приложений, но в этом примере мы будем использовать простой общий секретный пароль.

4. Нажмите клавишу F5 для сборки и запуска примера. При этом будут восстановлены зависимости пакета NuGet и откроется приложение.

   > Если при установке пакетов возникают ошибки, убедитесь, что локальный путь к решению не слишком длинный. Чтобы устранить эту проблему, переместите решение ближе к корню диска.

5. Войдите с помощью личной, рабочей или учебной учетной записи и предоставьте необходимые разрешения.

6. На начальной странице должны отобразиться изображение профиля и данные профиля в формате JSON.

7. Замените адрес электронной почты в поле на действующий адрес электронной почты какой-либо учетной записи в том же клиенте и нажмите кнопку **Загрузка данных**. После завершения операции на странице отобразится электронный адрес выбранного пользователя.

8. При необходимости измените список получателей, а затем нажмите кнопку **Отправить сообщение**. В верхней части страницы появится сообщение об успешной отправке.

## Ключевые компоненты примера

В следующих файлах приведен код, связанный с подключением к Microsoft Graph, загрузкой данных пользователя и отправкой почты.

- [`appsettings.json`](MicrosoftGraphAspNetCoreConnectSample/appsettings.json) содержит значения, используемые для проверки подлинности и авторизации.
- [`Startup.cs`](MicrosoftGraphAspNetCoreConnectSample/Startup.cs) настраивает приложение и используемые службы, включая проверку подлинности.

### Контроллеры

- [`AccountController.cs`](MicrosoftGraphAspNetCoreConnectSample/Controllers/AccountController.cs) обрабатывает вход и выход.
- [`HomeController.cs`](MicrosoftGraphAspNetCoreConnectSample/Controllers/HomeController.cs) обрабатывает запросы из пользовательского интерфейса.

### Представления

- [`Index.cshtml`](MicrosoftGraphAspNetCoreConnectSample/Views/Home/Index.cshtml) содержит пользовательский интерфейс примера.

### Вспомогательные средства

- [`GraphAuthProvider.cs`](MicrosoftGraphAspNetCoreConnectSample/Helpers/GraphAuthProvider.cs) получает маркер доступа MSAL методом **AcquireTokenSilent**.
- [`GraphSdkHelper.cs`](MicrosoftGraphAspNetCoreConnectSample/Helpers/GraphSDKHelper.cs) инициирует клиент SDK, используемый для взаимодействия с Microsoft Graph.
- [`GraphService.cs`](MicrosoftGraphAspNetCoreConnectSample/Helpers/GraphService.cs) содержит методы, использующие **GraphServiceClient** для создания и отправки вызовов в службу Microsoft Graph и обработки ответа.
  - Действие **GetUserJson** получает профиль пользователя по адресу электронной почты и преобразует его в формат JSON.
  - Действие **GetPictureBase64** получает фотографию из профиля пользователя и преобразует ее в строку формата Base64.
  - Действие **SendEmail** отправляет сообщение электронной почты от имени текущего пользователя.

## Участие

Если вы хотите добавить код в этот пример, просмотрите статью [CONTRIBUTING.MD](/CONTRIBUTING.md).

Этот проект соответствует [Правилам поведения разработчиков открытого кода Майкрософт](https://opensource.microsoft.com/codeofconduct/). Дополнительные сведения см. в разделе [часто задаваемых вопросов о правилах поведения](https://opensource.microsoft.com/codeofconduct/faq/). Если у вас возникли вопросы или замечания, напишите нам по адресу [opencode@microsoft.com](mailto:opencode@microsoft.com).

## Вопросы и комментарии

Мы будем рады получить ваши отзывы о примере приложения, подключающегося с использованием Microsoft Graph, для ASP.NET Core. Вы можете отправлять нам вопросы и предложения в разделе [Проблемы](https://github.com/microsoftgraph/aspnetcore-connect-sample/issues) этого репозитория.

Общие вопросы о Microsoft Graph следует задавать на сайте [Stack Overflow](https://stackoverflow.com/questions/tagged/MicrosoftGraph). Убедитесь, что ваши вопросы или комментарии содержат метку _[MicrosoftGraph]_.

Можно предложить изменения в Microsoft Graph на [UserVoice](https://officespdev.uservoice.com/).

## Дополнительные ресурсы

- [Документация по Microsoft Graph](https://developer.microsoft.com/graph)
- [Другие примеры приложений, подключающихся с использованием Microsoft Graph](https://github.com/MicrosoftGraph?q=connect)
- [Пример веб-перехватчиков Microsoft Graph для ASP.NET Core](https://github.com/microsoftgraph/aspnetcore-apponlytoken-webhooks-sample)
- [Пример приложения, подключающегося с использованием Microsoft Graph, для ASP.NET 4.6](https://github.com/microsoftgraph/aspnet-connect-sample)

## Авторские права

(c) Корпорация Майкрософт (Microsoft Corporation), 2019. Все права защищены.
